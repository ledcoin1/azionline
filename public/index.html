<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–î—É—Ä–∞–∫ –û–Ω–ª–∞–π–Ω</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-green-900 text-white">

<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;

function App() {
  const [socket, setSocket] = useState(null);
  const [roomId, setRoomId] = useState(null);
  const [players, setPlayers] = useState([]);
  const [hand, setHand] = useState([]);
  const [trump, setTrump] = useState(null);
  const [centralCards, setCentralCards] = useState([]);
  const [message, setMessage] = useState("");
  const [currentTurn, setCurrentTurn] = useState(null);
  const [tricksWon, setTricksWon] = useState({});
  const [gameOver, setGameOver] = useState(false);

  useEffect(() => {
    const sock = io();
    setSocket(sock);

    sock.on("waiting", (data) => {
      setMessage(`–û–π—ã–Ω –∫“Ø—Ç—ñ–ø —Ç“±—Ä: ${data.count}/3`);
    });

    sock.on("room_joined", (data) => {
      setRoomId(data.roomId);
      setPlayers(data.players);
      setMessage("Room-“ì–∞ “õ–æ—Å—ã–ª–¥—ã“£—ã–∑!");
    });

    sock.on("game_started", () => {
      setMessage("–û–π—ã–Ω –±–∞—Å—Ç–∞–ª–¥—ã!");
      setCentralCards([]);
    });

    sock.on("ask_round", (data) => {
      if(confirm(data.message)) {
        sock.emit("round_answer", { roomId, answer: true });
      } else {
        sock.emit("round_answer", { roomId, answer: false });
      }
    });

    sock.on("round_started", (data) => {
      setMessage(data.message);
    });

    sock.on("your_cards", (data) => {
      setHand(data.hand);
      setTrump(data.trump);
    });

    sock.on("your_turn", (data) => {
      setMessage(data.message);
      setCurrentTurn(sock.id);
    });

    sock.on("card_played", (data) => {
      setCentralCards(prev => [...prev, data]);
    });

    sock.on("trick_winner", (data) => {
      setTricksWon(data.tricksWon);
      setMessage(`–ñ“Ø—Ä—ñ—Å “±—Ç“õ–∞–Ω: ${data.winnerId}`);
      setCentralCards([]);
    });

    sock.on("game_ended", (data) => {
      setMessage(data.message);
      setGameOver(true);
      setCentralCards([]);
    });

    return () => sock.disconnect();
  }, []);

  const handlePlay = () => {
    if(socket) socket.emit("play");
  };

  const playCard = (card) => {
    if(socket && socket.id === currentTurn) {
      socket.emit("play_card", { roomId, card });
      setHand(hand.filter(c => c !== card));
      setCurrentTurn(null);
    } else {
      alert("–°—ñ–∑–¥—ñ“£ –∫–µ–∑–µ–≥—ñ“£—ñ–∑ –µ–º–µ—Å!");
    }
  };

  return (
    <div className="p-4 max-w-3xl mx-auto text-center">
      <h1 className="text-3xl font-bold mb-4">üÉè –î—É—Ä–∞–∫ –û–Ω–ª–∞–π–Ω</h1>
      <p className="mb-2">{message}</p>

      {!roomId && <button 
        className="bg-yellow-500 text-black font-bold px-4 py-2 rounded hover:bg-yellow-400"
        onClick={handlePlay}
      >–û–π–Ω–∞—Ç—É</button>}

      {roomId && (
        <>
          <div className="my-4">
            <h2 className="font-bold">–û–π—ã–Ω—à—ã–ª–∞—Ä:</h2>
            <div className="flex justify-center gap-4 mt-2">
              {players.map(p => (
                <div key={p.id} className={`p-2 border rounded ${p.id === socket.id ? "bg-yellow-500 text-black" : "bg-gray-800"}`}>
                  {p.id} <br/>
                  {tricksWon[p.id] || 0} –∂“Ø—Ä—ñ—Å
                </div>
              ))}
            </div>
          </div>

          <div className="my-4">
            <h2 className="font-bold">Trump:</h2>
            <div className="text-2xl">{trump}</div>
          </div>

          <div className="my-4">
            <h2 className="font-bold">–û—Ä—Ç–∞–ª—ã“õ—Ç–∞“ì—ã –∫–∞—Ä—Ç–∞–ª–∞—Ä:</h2>
            <div className="flex justify-center gap-4 mt-2">
              {centralCards.map((c, i) => (
                <div key={i} className="p-4 border rounded bg-gray-700 text-2xl">{c.card}</div>
              ))}
            </div>
          </div>

          <div className="my-4">
            <h2 className="font-bold">–°—ñ–∑–¥—ñ“£ –∫–∞—Ä—Ç–∞–ª–∞—Ä—ã“£—ã–∑:</h2>
            <div className="flex justify-center gap-4 mt-2">
              {hand.map((c, i) => (
                <button 
                  key={i}
                  className="p-4 border rounded bg-blue-500 hover:bg-blue-400 text-2xl"
                  onClick={() => playCard(c)}
                  disabled={gameOver}
                >
                  {c}
                </button>
              ))}
            </div>
          </div>

          {gameOver && <div className="mt-4 text-xl font-bold text-red-400">–û–π—ã–Ω –∞—è“õ—Ç–∞–ª–¥—ã!</div>}
        </>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

</body>
</html>
