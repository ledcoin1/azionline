<!DOCTYPE html>
<html>
<head>
  <title>Telegram MiniApp Lobby & Room</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/socket.io/socket.io.js"></script> <!-- Socket.IO –∫–ª–∏–µ–Ω—Ç -->
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body>

<h2>MiniApp Lobby & Room</h2>
<pre id="info">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</pre>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe?.user;

if(!user){
  document.getElementById("info").innerText = "‚ùå Telegram user —Ç–∞–±—ã–ª–º–∞–¥—ã";
} else {

  // 1Ô∏è‚É£ –ê–ª–¥—ã–º–µ–Ω —Å–µ—Ä–≤–µ—Ä–≥–µ login
  fetch("/api/login", {
    method: "POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ telegramId: String(user.id) })
  })
  .then(r => r.json())
  .then(data => {

    // 2Ô∏è‚É£ –ê–ª —Å–µ—Ä–≤–µ—Ä–≥–µ Socket.IO –∞—Ä“õ—ã–ª—ã “õ–æ—Å—ã–ª—É
    const socket = io("/", {
      auth: { telegramId: String(user.id) }
    });

    // –°–µ—Ä–≤–µ—Ä–¥–µ–Ω –±–∞–ª–∞–Ω—Å –∫–µ–ª–≥–µ–Ω–¥–µ –∫”©—Ä—Å–µ—Ç—É
    socket.on("balance", balance => {
      document.getElementById("info").innerText =
        "üÜî ID: " + data.telegramId +
        "\nüí∞ –ë–∞–ª–∞–Ω—Å: " + balance;
    });

    // –ê–ª“ì–∞—à“õ—ã –±–∞–ª–∞–Ω—Å —ç–∫—Ä–∞–Ω“ì–∞ —à—ã“ì–∞—Ä—É
    document.getElementById("info").innerText =
      "üÜî ID: " + data.telegramId +
      "\nüí∞ –ë–∞–ª–∞–Ω—Å: " + data.balance;

    // Room-“ì–∞ “õ–æ—Å—ã–ª“ì–∞–Ω–¥–∞ —Ö–∞–±–∞—Ä–ª–∞—É
    socket.on("joinedRoom", ({ roomId, players }) => {
      const info = "üÜî ID: " + data.telegramId +
                   "\nüí∞ –ë–∞–ª–∞–Ω—Å: " + data.balance +
                   "\nüéÆ Room: " + roomId +
                   "\nüë• Players: " + players.join(", ");
      document.getElementById("info").innerText = info;
    });

    // Disconnect –±–æ–ª“ì–∞–Ω–¥–∞ —Ö–∞–±–∞—Ä–ª–∞—É
    socket.on("disconnect", () => {
      document.getElementById("info").innerText += "\n‚ùå –°—ñ–∑ disconnect –±–æ–ª–¥—ã“£—ã–∑";
    });

  })
  .catch(err => {
    document.getElementById("info").innerText = "‚ùå Server error: " + err.message;
    console.error(err);
  });

}
</script>

</body>
</html>
