<!DOCTYPE html>
<html>
<head>
  <title>Telegram MiniApp Lobby & Room</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h2 { margin-bottom: 10px; }
    .section { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background: #fff; }
    ul { padding-left: 20px; }
    li { margin-bottom: 5px; }
    .bet { color: green; font-weight: bold; }
  </style>
</head>
<body>

<h2>MiniApp Lobby & Room</h2>

<div class="section">
  <strong>–°—ñ–∑–¥—ñ“£ –º”ô–ª—ñ–º–µ—Ç—ñ“£—ñ–∑:</strong>
  <div id="userInfo">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</div>
</div>

<div class="section">
  <strong>Lobby:</strong>
  <ul id="lobbyList"><li>–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</li></ul>
</div>

<div class="section">
  <strong>Room:</strong>
  <ul id="roomList"><li>–°—ñ–∑ ”ô–ª—ñ room-“ì–∞ “õ–æ—Å—ã–ª–º–∞“ì–∞–Ω—Å—ã–∑</li></ul>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe?.user;

if(!user){
  document.getElementById("userInfo").innerText = "‚ùå Telegram user —Ç–∞–±—ã–ª–º–∞–¥—ã";
} else {

  fetch("/api/login", {
    method: "POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ telegramId: String(user.id) })
  })
  .then(r => r.json())
  .then(data => {

    // –°—ñ–∑–¥—ñ“£ Telegram ID –∂”ô–Ω–µ –±–∞–ª–∞–Ω—Å—ã
    const userInfoEl = document.getElementById("userInfo");
    userInfoEl.innerText = `üÜî ID: ${data.telegramId}\nüí∞ –ë–∞–ª–∞–Ω—Å: ${data.balance}`;

    // Socket.IO “õ–æ—Å—É
    const socket = io("/", { auth: { telegramId: String(user.id) } });

    // Lobby –∂–∞“£–∞—Ä—Ç—É
    socket.on("lobbyUpdate", lobbyPlayers => {
      const lobbyEl = document.getElementById("lobbyList");
      if(lobbyPlayers.length === 0){
        lobbyEl.innerHTML = "<li>Lobby –±–æ—Å</li>";
      } else {
        lobbyEl.innerHTML = "";
        lobbyPlayers.forEach(id => {
          const li = document.createElement("li");
          li.innerText = id;
          lobbyEl.appendChild(li);
        });
      }
    });

    // Room –∂–∞“£–∞—Ä—Ç—É
    socket.on("joinedRoom", ({ roomId, players }) => {
      const roomEl = document.getElementById("roomList");
      roomEl.innerHTML = "";
      players.forEach(p => {
        const li = document.createElement("li");
        li.innerText = p.id === data.telegramId ? p.id + " (–°—ñ–∑)" : p.id;
        roomEl.appendChild(li);
      });
      roomEl.insertAdjacentHTML("beforeend", `<li>üéÆ Room ID: ${roomId}</li>`);
    });

    // Bet request (—Å“±—Ä–∞“õ) —Ö–∞–±–∞—Ä–ª–∞–º–∞—Å—ã–Ω –∞–ª—É
    socket.on("betRequest", data => {
      console.log("üí∞ –°“±—Ä–∞“õ –∫–µ–ª–¥—ñ:", data); // —Ç–µ—Ä–º–∏–Ω–∞–ª–¥–∞ –±–∞“õ—ã–ª–∞—É

      const roomEl = document.getElementById("roomList");
      const li = document.createElement("li");
      li.innerText = `üí∞ –°—Ç–∞–≤–∫–∞: ${data.bet}, –¢–∞–π–º–µ—Ä: ${data.timer} —Å–µ–∫—É–Ω–¥`;
      li.classList.add("bet");
      roomEl.appendChild(li);
    });

    // –ë–∞–ª–∞–Ω—Å –∂–∞“£–∞—Ä—Ç—É
    socket.on("balance", balance => {
      userInfoEl.innerText = `üÜî ID: ${data.telegramId}\nüí∞ –ë–∞–ª–∞–Ω—Å: ${balance}`;
    });

    // Disconnect —Ö–∞–±–∞—Ä
    socket.on("disconnect", () => {
      userInfoEl.innerText += "\n‚ùå –°—ñ–∑ disconnect –±–æ–ª–¥—ã“£—ã–∑";
    });

    // –ê–ª“ì–∞—à“õ—ã Lobby –∫”©—Ä—Å–µ—Ç—É
    socket.emit("requestLobby"); // —Å–µ—Ä–≤–µ—Ä–¥–µ –æ—Å—ã –æ“õ–∏“ì–∞ –±–æ–ª—Å–∞ lobby —Ç—ñ–∑—ñ–º—ñ–Ω –∂—ñ–±–µ—Ä—É
  })
  .catch(err => {
    document.getElementById("userInfo").innerText = "‚ùå Server error: " + err.message;
    console.error(err);
  });

}
</script>

</body>
</html>
