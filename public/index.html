<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ê–ó–ò 3 –ö–ê–†–¢–ê</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<h2>üÉè –ê–ó–ò (3 –∫–∞—Ä—Ç–∞)</h2>
<div id="info"></div>
<div id="hand"></div>

<script>
if (!window.Telegram) {
  document.body.innerHTML = "–¢–µ–∫ Telegram!";
  throw "";
}

const userId = Telegram.WebApp.initDataUnsafe.user.id;
const socket = io();
let roomId = null;

socket.emit("joinGame", { userId });

socket.on("waiting", () => {
  info.innerText = "“ö–∞—Ä—Å—ã–ª–∞—Å –∫“Ø—Ç—ñ–ª—É–¥–µ...";
});

socket.on("start", room => {
  roomId = Object.keys(room.hands)[0] ? roomId : roomId;
  render(room);
});

socket.on("update", render);

socket.on("gameEnd", tricks => {
  info.innerText = tricks[userId] > tricks[Object.keys(tricks).find(i=>i!=userId)]
    ? "üèÜ –ñ–ï“¢–î–Ü“¢"
    : "‚ùå “∞–¢–´–õ–î–´“¢";
});

function render(room) {
  info.innerText = `–ö”©–∑—ñ—Ä: ${room.trump} | –ö–µ–∑–µ–∫: ${room.turn}`;
  hand.innerHTML = "";

  room.hands[userId].forEach((c, i) => {
    const btn = document.createElement("button");
    btn.innerText = c.suit + c.value;
    btn.onclick = () => {
      socket.emit("playCard", { roomId, userId, cardIndex: i });
    };
    hand.appendChild(btn);
  });
}
</script>

</body>
</html>
