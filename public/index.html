<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>Mini App Online</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 40px 20px;
    }
    h1 { font-size: 32px; color: #22c55e; }
    button { padding: 15px 30px; border-radius: 12px; background: #22c55e; border: none; cursor: pointer; font-size: 18px; margin-top: 20px; transition: 0.2s; }
    button:hover { background: #16a34a; transform: scale(1.05); }
    #main-screen, #game-screen { display: none; }
    #main-screen.active, #game-screen.active { display: block; }
    #players { margin-top: 20px; display: inline-block; text-align: left; padding: 10px; border: 2px solid #22c55e; border-radius: 12px; background: rgba(0,0,0,0.3); }
    #hand { margin-top: 30px; display: flex; justify-content: center; gap: 15px; perspective: 1000px; }
    .card { width: 80px; height: 120px; border-radius: 12px; background: #fefefe; color: #111; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; box-shadow: 0 8px 15px rgba(0,0,0,0.3); transform: rotateY(0deg); transition: 0.3s; cursor: pointer; }
    .card:hover { transform: rotateY(15deg) translateY(-10px); box-shadow: 0 15px 25px rgba(0,0,0,0.5); }
    #trump { margin-top: 20px; font-size: 20px; color: #facc15; }
    #game-messages { margin-top: 20px; font-size: 18px; color: #38bdf8; }
  </style>
</head>
<body>
<h1>Mini App Online</h1>

<div id="main-screen" class="active">
  <p id="user">Ð–Ò¯ÐºÑ‚ÐµÐ»ÑƒÐ´Ðµ...</p>
  <button id="playBtn">Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ</button>
  <div id="messages"></div>
</div>

<div id="game-screen">
  <h2>ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° Ð°ÑˆÑ‹Ð»Ð´Ñ‹! ðŸŽ®</h2>
  <ul id="players"></ul>
  <div id="hand-title"><h3>Ð¡Ñ–Ð·Ð´Ñ–Ò£ Ò›Ð¾Ð»Ñ‹Ò£Ñ‹Ð·:</h3></div>
  <div id="hand"></div>
  <div id="trump"></div>
  <div id="game-messages"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

const socket = io();

const user = tg.initDataUnsafe.user;
const playerName = user ? user.first_name : "ÐÑ‚Ñ‹ Ð¶Ð¾Ò› Ð¾Ð¹Ñ‹Ð½ÑˆÑ‹";
document.getElementById("user").innerText = user ? `Ð¡Ó™Ð»ÐµÐ¼, ${user.first_name}` : "Telegram user Ð¶Ð¾Ò›";

const mainScreen = document.getElementById("main-screen");
const gameScreen = document.getElementById("game-screen");
const messagesDiv = document.getElementById("messages");
const gameMessagesDiv = document.getElementById("game-messages");
const playersList = document.getElementById("players");
const handDiv = document.getElementById("hand");
const trumpDiv = document.getElementById("trump");

document.getElementById("playBtn").onclick = () => {
  socket.emit("join game", playerName);
  messagesDiv.innerText = "Ð¡ÐµÑ€Ð²ÐµÑ€Ð³Ðµ Ò›Ð¾ÑÑ‹Ð»ÑƒÐ´Ð°...";
};

// ÐžÐ¹Ñ‹Ð½ÑˆÑ‹Ð»Ð°Ñ€ Ñ‚Ñ–Ð·Ñ–Ð¼Ñ– Ð¶Ð°Ò£Ð°Ñ€Ñ‚Ñƒ
socket.on("update players", (players) => {
  playersList.innerHTML = "";
  players.forEach(p => {
    const li = document.createElement("li");
    li.innerText = p.name;
    playersList.appendChild(li);
  });
});

// ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° Ð°ÑˆÑ‹Ð»Ð´Ñ‹
socket.on("room started", (players) => {
  mainScreen.classList.remove("active");
  gameScreen.classList.add("active");
  gameMessagesDiv.innerText = "ÐžÐ¹Ñ‹Ð½ Ð±Ð°ÑÑ‚Ð°Ð»Ð´Ñ‹! ðŸŽ®";

  playersList.innerHTML = "";
  players.forEach(p => {
    const li = document.createElement("li");
    li.innerText = p.name;
    playersList.appendChild(li);
  });

  renderHand(players);
});

// ÐšÓ©Ð·Ñ–Ñ€ ÐºÓ©Ñ€ÑÐµÑ‚Ñƒ
socket.on("trump", (trump) => {
  trumpDiv.innerText = `ÐšÓ©Ð·Ñ–Ñ€: ${trump.value}${trump.suit[0].toUpperCase()}`;
});

// ÐšÐµÐ·ÐµÐº Ð±Ð¾Ð¹Ñ‹Ð½ÑˆÐ° Ñ…Ð°Ð±Ð°Ñ€
socket.on("turn", (playerId) => {
  if (socket.id === playerId) {
    gameMessagesDiv.innerText = "Ð¡Ñ–Ð·Ð´Ñ–Ò£ ÐºÐµÐ·ÐµÐ³Ñ–Ò£Ñ–Ð·! ÐšÐ°Ñ€Ñ‚Ð°Ð½Ñ‹ Ð±Ð°ÑÑ‹Ò£Ñ‹Ð·";
    handDiv.querySelectorAll(".card").forEach(cardDiv => {
      cardDiv.style.cursor = "pointer";
      cardDiv.onclick = () => {
        const card = {
          value: cardDiv.dataset.value,
          suit: cardDiv.dataset.suit
        };
        socket.emit("play card", { roomId: null, card }); // roomId ÑÐµÑ€Ð²ÐµÑ€Ð´ÐµÐ½ Ò›Ð°Ð¹Ñ‚Ð°Ñ€Ñƒ ÐºÐµÑ€ÐµÐº
        cardDiv.remove(); // ÐºÐ°Ñ€Ñ‚Ð° Ò›Ð¾Ð»Ð´Ð°Ð½ ÑˆÑ‹Ò“Ð°Ð´Ñ‹
      };
    });
  } else {
    gameMessagesDiv.innerText = "ÐšÐµÐ·ÐµÐº Ð±Ð°ÑÒ›Ð° Ð¾Ð¹Ñ‹Ð½ÑˆÑ‹Ð´Ð°...";
  }
});

// ÐžÐ¹Ñ‹Ð½ÑˆÑ‹Ð½Ñ‹Ò£ Ò›Ð¾Ð»Ñ‹Ð½ ÐºÓ©Ñ€ÑÐµÑ‚Ñƒ
function renderHand(players) {
  const me = players.find(p => p.name === playerName);
  if (me && me.hand) {
    handDiv.innerHTML = "";
    me.hand.forEach(card => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerText = `${card.value}${card.suit[0].toUpperCase()}`;
      div.dataset.value = card.value;
      div.dataset.suit = card.suit;
      handDiv.appendChild(div);
    });
  }
}

// ÐžÐ¹Ñ‹Ð½ Ð°ÑÒ›Ñ‚Ð°Ð»Ñƒ
socket.on("game over", (msg) => {
  gameMessagesDiv.innerText = msg;
  handDiv.innerHTML = "";
});
</script>
</body>
</html>
