<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3 Ойыншы Карточка Ойыны</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #players { margin-bottom: 20px; }
    .player { margin: 5px 0; }
    #gameArea { border: 1px solid #ccc; padding: 10px; width: 400px; }
    #messages { height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; margin-top: 10px; }
    button { margin: 5px; }
  </style>
</head>
<body>

<h1>3 Ойыншы Карточка Ойыны</h1>

<div>
  <label>Аты-жөніңіз: <input type="text" id="nameInput"></label>
  <button id="joinBtn">Қосылу</button>
</div>

<div id="players"></div>

<div id="gameArea" style="display:none;">
  <div id="turnMessage"></div>
  
  <div id="firstPlayerArea" style="display:none;">
    <label>Ставка (50-150): <input type="number" id="betInput"></label>
    <button id="betBtn">Жіберу</button>
  </div>

  <div id="decisionArea" style="display:none;">
    <button id="acceptBtn">Келісемін</button>
    <button id="foldBtn">Отбой</button>
  </div>

  <div id="messages"></div>
</div>

<script>
  const socket = io();

  let myId = null;
  let myIndex = null; // 0,1,2 ойыншының индексі

  const playersDiv = document.getElementById('players');
  const gameArea = document.getElementById('gameArea');
  const turnMessage = document.getElementById('turnMessage');
  const firstPlayerArea = document.getElementById('firstPlayerArea');
  const betInput = document.getElementById('betInput');
  const betBtn = document.getElementById('betBtn');
  const decisionArea = document.getElementById('decisionArea');
  const acceptBtn = document.getElementById('acceptBtn');
  const foldBtn = document.getElementById('foldBtn');
  const messagesDiv = document.getElementById('messages');

  const nameInput = document.getElementById('nameInput');
  const joinBtn = document.getElementById('joinBtn');

  joinBtn.onclick = () => {
    const name = nameInput.value.trim();
    if (!name) return alert("Атыңызды енгізіңіз!");
    socket.emit("join", name);
    nameInput.disabled = true;
    joinBtn.disabled = true;
  }

  function logMessage(msg) {
    const p = document.createElement("div");
    p.textContent = msg;
    messagesDiv.appendChild(p);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // --- Серверден оқиғалар ---
  socket.on("room_update", (data) => {
    playersDiv.innerHTML = "<b>Ойыншылар:</b><br>";
    data.players.forEach((p, i) => {
      playersDiv.innerHTML += `<div class="player">${i+1}. ${p.name} (Баланс: ${p.balance})</div>`;
      if (p.id === socket.id) myId = p.id, myIndex = i;
    });
  });

  socket.on("game_started", (data) => {
    logMessage("Ойын басталды!");
    gameArea.style.display = "block";
  });

  socket.on("your_turn", (data) => {
    turnMessage.textContent = data.message;

    if (myIndex === 0) {
      firstPlayerArea.style.display = "block";
      decisionArea.style.display = "none";
    } else {
      firstPlayerArea.style.display = "none";
      decisionArea.style.display = "block";
    }
  });

  // Бірінші ойыншы ставка жіберу
  betBtn.onclick = () => {
    const bet = parseInt(betInput.value);
    if (!bet || bet < 50 || bet > 150) return alert("50-150 аралығында сан енгізіңіз!");
    socket.emit("first_player_bet", { bet });
    firstPlayerArea.style.display = "none";
    logMessage(`Сіздің ставкаңыз: ${bet}`);
  }

  // Келісемін / Отбой батырмалары
  acceptBtn.onclick = () => {
    if (myIndex === 1) socket.emit("second_player_decision", { decision: "accept" });
    if (myIndex === 2) socket.emit("third_player_decision", { decision: "accept" });
    decisionArea.style.display = "none";
    logMessage("Сіз Келісемін деп таңдадыңыз.");
  }

  foldBtn.onclick = () => {
    if (myIndex === 1) socket.emit("second_player_decision", { decision: "fold" });
    if (myIndex === 2) socket.emit("third_player_decision", { decision: "fold" });
    decisionArea.style.display = "none";
    logMessage("Сіз Отбой деп таңдадыңыз.");
  }

  // Серверден ставкалар мен шешімдерді көрсету
  socket.on("first_player_bet_doubled", (data) => {
    logMessage(`2-ойыншыға ставка жіберілді: ${data.bet}`);
  });

  socket.on("second_player_bet_doubled_again", (data) => {
    logMessage(`3-ойыншыға ставка жіберілді: ${data.bet}`);
  });

  socket.on("second_player_folded_bet", (data) => {
    logMessage(`2-ойыншы Отбой, 3-ойыншыға ставка: ${data.bet}`);
  });

  socket.on("game_result", (data) => {
    logMessage(`Нәтиже: ${data.message}`);
    if (data.finalBets) logMessage(`Ставкалар: ${JSON.stringify(data.finalBets)}`);
  });

</script>
</body>
</html>
