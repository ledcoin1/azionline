<!DOCTYPE html>
<html>
<head>
  <title>Telegram MiniApp Lobby & Room</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h2 { margin-bottom: 10px; }
    .section { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background: #fff; }
    ul { padding-left: 20px; }
    li { margin-bottom: 5px; }
    .cards { display: flex; gap: 10px; margin-top: 10px; }
    .card { width: 40px; height: 60px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 5px; }
    .middle { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

<h2>MiniApp Lobby & Room</h2>

<div class="section">
  <strong>–°—ñ–∑–¥—ñ“£ –º”ô–ª—ñ–º–µ—Ç—ñ“£—ñ–∑:</strong>
  <div id="userInfo">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</div>
</div>

<div class="section">
  <strong>Lobby:</strong>
  <ul id="lobbyList"><li>–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</li></ul>
</div>

<div class="section">
  <strong>Room:</strong>
  <ul id="roomList"><li>–°—ñ–∑ ”ô–ª—ñ room-“ì–∞ “õ–æ—Å—ã–ª–º–∞“ì–∞–Ω—Å—ã–∑</li></ul>
</div>

<div class="section">
  <strong>–°—ñ–∑–¥—ñ“£ –∫–∞—Ä—Ç–∞–ª–∞—Ä—ã“£—ã–∑:</strong>
  <div id="playerCards" class="cards"></div>
  <div id="middleCard" class="middle"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
const user = tg.initDataUnsafe?.user;

if(!user){
  document.getElementById("userInfo").innerText = "‚ùå Telegram user —Ç–∞–±—ã–ª–º–∞–¥—ã";
} else {
  fetch("/api/login", {
    method: "POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ telegramId: String(user.id) })
  })
  .then(r => r.json())
  .then(data => {
    const userInfoEl = document.getElementById("userInfo");
    userInfoEl.innerText = `üÜî ID: ${data.telegramId}\nüí∞ –ë–∞–ª–∞–Ω—Å: ${data.balance}`;

    const socket = io("/", { auth: { telegramId: String(user.id) } });

    // Lobby –∂–∞“£–∞—Ä—Ç—É
    socket.on("lobbyUpdate", lobbyPlayers => {
      const lobbyEl = document.getElementById("lobbyList");
      if(lobbyPlayers.length === 0){
        lobbyEl.innerHTML = "<li>Lobby –±–æ—Å</li>";
      } else {
        lobbyEl.innerHTML = "";
        lobbyPlayers.forEach(id => {
          const li = document.createElement("li");
          li.innerText = id;
          lobbyEl.appendChild(li);
        });
      }
    });

    // Room –∂–∞“£–∞—Ä—Ç—É
    socket.on("joinedRoom", ({ roomId, players }) => {
      const roomEl = document.getElementById("roomList");
      roomEl.innerHTML = "";
      players.forEach(id => {
        const li = document.createElement("li");
        li.innerText = id === data.telegramId ? id + " (–°—ñ–∑)" : id;
        roomEl.appendChild(li);
      });
      roomEl.insertAdjacentHTML("beforeend", `<li>üéÆ Room ID: ${roomId}</li>`);
    });

    // –ë–∞–ª–∞–Ω—Å –∂–∞“£–∞—Ä—Ç—É
    socket.on("balance", balance => {
      userInfoEl.innerText = `üÜî ID: ${data.telegramId}\nüí∞ –ë–∞–ª–∞–Ω—Å: ${balance}`;
    });

    // Disconnect —Ö–∞–±–∞—Ä
    socket.on("disconnect", () => {
      userInfoEl.innerText += "\n‚ùå –°—ñ–∑ disconnect –±–æ–ª–¥—ã“£—ã–∑";
    });

    // Bet request –∫–µ–ª—Å–µ
    socket.on("betRequest", ({ roomId, bet, timer }) => {
      console.log(`üí∞ Bet request: ${bet}, —Ç–∞–π–º–µ—Ä ${timer}s`);
      // –ê–≤—Ç–æ–º–∞—Ç—Ç—ã “õ–∞–±—ã–ª–¥–∞—É (–º—ã—Å–∞–ª—ã —Ç–µ—Å—Ç “Ø—à—ñ–Ω)
      setTimeout(() => {
        socket.emit("playerResponse", { telegramId: data.telegramId, response: "accepted" });
      }, 1000);
    });

    // –ö–∞—Ä—Ç–∞–ª–∞—Ä–¥—ã –∞–ª—É
    socket.on("dealCards", ({ roomId, cards }) => {
      const playerCardsEl = document.getElementById("playerCards");
      playerCardsEl.innerHTML = "";
      cards.forEach(c => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerText = c;
        playerCardsEl.appendChild(div);
      });
    });

    // –û—Ä—Ç–∞ –∫–∞—Ä—Ç–∞—Å—ã–Ω –∫”©—Ä—Å–µ—Ç—É
    socket.on("middleCard", ({ card }) => {
      document.getElementById("middleCard").innerText = `üÇ† –û—Ä—Ç–∞“ì–∞ –∫–∞—Ä—Ç–∞: ${card}`;
    });

    // –ê–ª“ì–∞—à“õ—ã Lobby –∫”©—Ä—Å–µ—Ç—É
    socket.emit("requestLobby");
  })
  .catch(err => {
    document.getElementById("userInfo").innerText = "‚ùå Server error: " + err.message;
    console.error(err);
  });
}
</script>

</body>
</html>
