<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3 Player Turn-Based Game</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #players { margin-bottom: 20px; }
    .player { margin: 5px 0; }
    button { margin: 5px; padding: 5px 10px; }
    input[type=number] { width: 60px; }
    .disabled { opacity: 0.5; pointer-events: none; }
    #messages { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
  </style>
</head>
<body>
  <h1>3 Player Turn-Based Game</h1>

  <div id="join-section">
    <input type="text" id="playerName" placeholder="Атыңыз">
    <button id="joinBtn">Қосылу</button>
  </div>

  <div id="game-section" style="display:none;">
    <h2>Players:</h2>
    <div id="players"></div>

    <div id="turn-section" style="margin-top: 20px;">
      <div id="turn-message"></div>
      <div id="bet-section">
        <input type="number" id="betInput" min="50" max="150" placeholder="50-150">
        <button id="betBtn">Ставка жасау</button>
      </div>
      <div id="action-section" style="margin-top:10px;">
        <button id="acceptBtn">Келісемін</button>
        <button id="foldBtn">Отбой</button>
      </div>
    </div>

    <div id="messages"></div>
  </div>

  <script>
    const socket = io();

    const joinSection = document.getElementById('join-section');
    const joinBtn = document.getElementById('joinBtn');
    const playerNameInput = document.getElementById('playerName');

    const gameSection = document.getElementById('game-section');
    const playersDiv = document.getElementById('players');
    const turnMessage = document.getElementById('turn-message');
    const betSection = document.getElementById('bet-section');
    const betInput = document.getElementById('betInput');
    const betBtn = document.getElementById('betBtn');
    const actionSection = document.getElementById('action-section');
    const acceptBtn = document.getElementById('acceptBtn');
    const foldBtn = document.getElementById('foldBtn');
    const messagesDiv = document.getElementById('messages');

    let playerId = null;
    let currentTurn = false;

    // --- Join ---
    joinBtn.addEventListener('click', () => {
      const name = playerNameInput.value.trim();
      if (!name) return alert('Атыңызды енгізіңіз');
      socket.emit('join', name);
      joinSection.style.display = 'none';
      gameSection.style.display = 'block';
    });

    // --- Update room ---
    socket.on('room_update', (data) => {
      playersDiv.innerHTML = '';
      data.players.forEach(p => {
        const div = document.createElement('div');
        div.className = 'player';
        div.textContent = `${p.name} (${p.balance})`;
        playersDiv.appendChild(div);
      });
    });

    // --- Game started ---
    socket.on('game_started', (data) => {
      addMessage('Ойын басталды!');
    });

    // --- Turn ---
    socket.on('your_turn', (data) => {
      currentTurn = true;
      turnMessage.textContent = data.message;
      toggleControls(true);
      addMessage('Сіздің кезегіңіз келді.');
    });

    // --- First player bet ---
    betBtn.addEventListener('click', () => {
      if (!currentTurn) return;
      const value = parseInt(betInput.value);
      if (isNaN(value) || value < 50 || value > 150) return alert('50-150 аралығында сан енгізіңіз');
      socket.emit('first_player_bet', { bet: value });
      addMessage(`Ставка жіберілді: ${value}`);
      toggleControls(false);
      currentTurn = false;
    });

    // --- Accept / Fold ---
    acceptBtn.addEventListener('click', () => {
      if (!currentTurn) return;
      if (betSection.style.display !== 'none') {
        socket.emit('second_player_accept');
        addMessage('Келістім жіберілді');
      } else {
        socket.emit('third_player_accept');
        addMessage('Келістім жіберілді');
      }
      toggleControls(false);
      currentTurn = false;
    });

    foldBtn.addEventListener('click', () => {
      if (!currentTurn) return;
      if (betSection.style.display !== 'none') {
        socket.emit('second_player_fold');
        addMessage('Отбой жіберілді');
      } else {
        socket.emit('third_player_fold');
        addMessage('Отбой жіберілді');
      }
      toggleControls(false);
      currentTurn = false;
    });

    // --- Server signals for updates ---
    socket.on('first_player_bet_doubled', (data) => {
      addMessage(`1-ойыншы ставкасы 2 еселенді: ${data.bet}`);
      // Екінші ойыншы кезегі
      betSection.style.display = 'none';
      turnMessage.textContent = 'Сіздің кезегіңіз!';
      toggleControls(true);
    });

    socket.on('second_player_bet_doubled_again', (data) => {
      addMessage(`2-ойыншы ставкасы тағы 2 еселенді: ${data.bet}`);
      betSection.style.display = 'none';
      turnMessage.textContent = 'Сіздің кезегіңіз!';
      toggleControls(true);
    });

    socket.on('second_player_folded_bet', (data) => {
      addMessage(`2-ойыншы отбой, ставка: ${data.bet}`);
      betSection.style.display = 'none';
      turnMessage.textContent = 'Сіздің кезегіңіз!';
      toggleControls(true);
    });

    socket.on('round_finished', (data) => {
      addMessage(`Раунд аяқталды! Соңғы ставка: ${data.finalBet}`);
      turnMessage.textContent = '';
      toggleControls(false);
    });

    function toggleControls(enable) {
      betBtn.disabled = !enable;
      betInput.disabled = !enable;
      acceptBtn.disabled = !enable;
      foldBtn.disabled = !enable;
    }

    function addMessage(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

  </script>
</body>
</html>
